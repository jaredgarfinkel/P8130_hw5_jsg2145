---
title: "P8130_hw5_jsg2145"
author: "Jared Garfinkel"
date: "12/6/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(faraway)
library(arsenal)
library(leaps)
library(caret)
library(broom)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
``````

```{r}
states <- attributes(state.x77) %>% 
  .[[2]] %>% 
  .[[1]]

df <- cbind(states, state.x77) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(population = as.numeric(population),
         income = as.numeric(income),
         illiteracy = as.numeric(illiteracy),
         life_exp = as.numeric(life_exp),
         murder = as.numeric(murder),
         hs_grad = as.numeric(hs_grad),
         frost = as.numeric(frost),
         area = as.numeric(area))

str(df)
```

```{r}
tab1 <- tableby( ~ population + income + illiteracy + life_exp + murder + hs_grad + frost + area, data=df)

my_labels <- list(population = "Population", 
                  income = "Per Capita Income", 
                  illiteracy = "Illiteracy, Percent of Population", 
                  life_exp = "Life Expectancy in Years", 
                  murder = "Murder Rate per 100,000", 
                  hs_grad = "Percent High-School Graduates", 
                  frost = "Mean Number of Days with Minimum Temp Below Freezing", 
                  area = "Land Area (sq mi)")

my_controls <- tableby.control(
               total = T,
               test = F,  # No test p-values yet
               numeric.stats = c("meansd", "medianq1q3", "range"),
               stats.labels = list(
               meansd = "Mean (SD)",
               medianq1q3 = "Median (Q1, Q3)",
               range = "Min - Max"))

tab2 <- tableby( ~ population + income + illiteracy + life_exp + murder + hs_grad + frost + area, data=df, control=my_controls)

summary(tab2, title = "Descriptive Statistics: Life Expectancy Data", labelTranslations = my_labels, text=T) %>% 
  data.frame() %>% 
  knitr::kable()

```

```{r}
df %>% 
  ggplot(aes(x = life_exp)) + 
  geom_histogram(bins = 10)
```
```{r}
skimr::skim(df)
```

```{r}
df %>% 
  ggplot(aes(x = frost)) +
  geom_histogram(bins = 10)
```

 
```{r}
df %>% 
  ggplot(aes(x = log(population))) +
  geom_histogram(bins = 10)
```

```{r}
df %>% 
  ggplot(aes(x = income, y = life_exp)) +
  geom_point()
```

```{r}
df %>% 
  ggplot(aes(x = illiteracy, y = life_exp)) +
  geom_point()
```

```{r}
df <- df %>% 
  mutate(ln_pop = log(population),
         ln_area = log(area))
```

```{r}
fit1 <- lm(life_exp ~ population, data = df)
broom::tidy(fit1)$p.value[2]
fit2 <- lm(life_exp ~ murder, data = df)
broom::tidy(fit2)$p.value[2]
fit3 <- lm(life_exp ~ income, data = df)
broom::tidy(fit3)$p.value[2]
fit4 <- lm(life_exp ~ illiteracy, data = df)
broom::tidy(fit4)$p.value[2]
fit5 <- lm(life_exp ~ hs_grad, data = df)
broom::tidy(fit5)$p.value[2]
fit6 <- lm(life_exp ~ frost, data =df)
broom::tidy(fit6)$p.value[2]
fit7 <- lm(life_exp ~ area, data = df)
broom::tidy(fit7)$p.value[2]
fit8 <- lm(life_exp ~ log(population), data = df)
broom::tidy(fit8)$p.value[2]
fit9 <- lm(life_exp ~ log(area), data = df)
broom::tidy(fit9)$p.value[2]

# murder has the lowest p-value

forward1<-lm(life_exp ~ murder, data = state_data)
broom::tidy(forward1)

fit1 <- update(forward1, . ~ . + income)
broom::tidy(fit1)$p.value[3] # 0.06663619

fit2 <- update(forward1, . ~ . + ln_pop)
broom::tidy(fit2)$p.value[3] # 0.04008758

fit3 <- update(forward1, . ~ . + illiteracy)
broom::tidy(fit3)$p.value[3] # 0.5429104

fit4 <- update(forward1, . ~ . + hs_grad)
broom::tidy(fit4)$p.value[3] # 0.009088366

fit5 <- update(forward1, . ~ . + frost)
broom::tidy(fit5)$p.value[3] # 0.03520523

fit6 <- update(forward1, . ~ . + ln_area)
broom::tidy(fit6)$p.value[3] # 0.1561891
```

```{r}
# next highest p-value is hs_grad

forward2 <- update(forward1, . ~ . + hs_grad)
tidy(forward2)

fit1 <- update(forward2, . ~ . + ln_population)
tidy(fit1)$p.value[4] # 0.005516215

fit2 <- update(forward2, . ~ . + income)
tidy(fit2)$p.value[4] # 0.6924184

fit3 <- update(forward2, . ~ . + illiteracy)
tidy(fit3)$p.value[4] # 0.4094209

fit4 <- update(forward2, . ~ . + frost)
tidy(fit4)$p.value[4] # 0.006987727

fit5 <- update(forward2, . ~ . + ln_area)
tidy(fit5)$p.value[4] # 0.6634469
```

```{r}
fit_back <- lm(life_exp ~ . -states -population -area, data = df)
broom::tidy(fit_back) ## remove income
fit_back2 <- lm(life_exp ~ . -states -population -area -income, data = df)
broom::tidy(fit_back2) ## remove illiteracy
fit_back3 <- lm(life_exp ~ . -states -population -area -income -illiteracy, data = df)
broom::tidy(fit_back3) ## remove ln_area
fit_back3 <- lm(life_exp ~ . -states -population -area -income -illiteracy -ln_area, data = df)
broom::tidy(fit_back3) ## remove

vif(fit_back)
summary(fit_back3)

fit_states <- lm(life_exp ~ states, data = df)
anova(fit_states)
```

```{r}
df %>% 
  ggplot(aes(x = illiteracy, y = hs_grad)) +
  geom_point()
```

```{r}
fit <- lm(life_exp ~ hs_grad + illiteracy, data = df)
vif(fit)
summary(fit)

```



```{r}
model1 <- step(fit1, direction = "both")
model2 <- step(fit1, direction = "backward")
model3 <- step(fit_back, direction = "forward")
model2 <- step
```

```{r}
output = vector(mode = "list", length = 7)

df = df %>% 
  select(-states)

for (i in 1:7) {
  output[[i]] = lm(life_exp ~ df[[i]], data = df) %>%
    broom::tidy() %>% 
    tibble(
      variable = colnames(df[i]),
      pvalue = .$p.value[[2]]
    ) %>% 
    select(variable, pvalue) %>% 
    bind_rows()
}
```

```{r}
df = df %>% 
  select(life_exp, everything(), -population, -area) %>% 
  data.frame()

leaps(x = df[,2:8], y = df[,1], nbest = 2, method = "Cp")

leaps(x = df[,2:8], y = df[,1], nbest = 2, method = "adjr2")
```

```{r}
b <- regsubsets(life_exp ~ ., data=df)
   (rs <- summary(b))
```


```{r}
par(mar=c(4,4,1,1))
par(mfrow=c(1,2))

plot(2:8, rs$cp, xlab="No of parameters", ylab="Cp Statistic")
abline(0,1)

plot(2:8, rs$adjr2, xlab="No of parameters", ylab="Adj R2")
```

```{r}
# AIC of the 6-predictor model:
multi.fit4 <- lm(life_exp ~ murder + hs_grad + ln_pop + frost, data=df)
AIC(multi.fit4)

# BIC
AIC(multi.fit4, k = log(length(pull(df, life_exp))))

# AIC of the 4-predictor model:
multi.fit5 <- lm(life_exp ~ murder + hs_grad + ln_pop + frost + ln_area, data = df)
AIC(multi.fit5)

# 4-predictor model is the best
```

```{r}
par(mfrow =c(2, 2))
plot(multi.fit4)

```

```{r}
influence.measures(multi.fit4)
```


```{r}
df.no11 <- df[-11,]

multi.fit2 <- lm(life_exp ~ murder + hs_grad + ln_pop + frost, data = df.no11)

par(mfrow =c(2,2))
plot(multi.fit2)
```

```{r}
summary(multi.fit2)
summary(multi.fit4)
```

This is evidence that the influential point at observation 11 causes a variable, frost, to become not significant.

```{r}
set.seed(1)
data_train<-trainControl(method="cv", number=10)
```

```{r}
model_caret <- train(life_exp ~ murder + hs_grad + ln_pop + frost,
                   data=df,
                   trControl=data_train,
                   method='lm',
                   na.action=na.pass)

model_caret

model_caret$finalModel

model_caret$resample

sd(model_caret$resample$Rsquared)

full_model <- lm(life_exp ~ murder + hs_grad + ln_pop + frost, data = df)
summary(full_model)
```

